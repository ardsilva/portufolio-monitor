<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Monitor de Portf√≥lio ‚Äî 10 Ativos / Cen√°rio 2</title>
<style>
  body {font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:20px; color:#0b2545;}
  h1,h2,h3{color:#072244}
  table{border-collapse:collapse;width:100%;margin-bottom:12px}
  th,td{border:1px solid #d7e0ee;padding:8px;text-align:left;font-size:14px}
  th{background:#eef6ff}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type="number"], input[type="text"], input[type="password"], select {width:100%;padding:8px;border:1px solid #cbd7ea;border-radius:4px}
  button{background:#0b5ed7;color:#fff;padding:8px 12px;border:0;border-radius:6px;cursor:pointer;margin-right:8px}
  button.secondary{background:#6c7a89}
  .note{font-size:13px;color:#4b5563;margin-top:8px}
  .error{color:#a80000;font-weight:700}
  .success{color:#0a7a3b;font-weight:700}
  .small{font-size:13px;color:#4b5563}
  .flex{display:flex;gap:8px;align-items:center}
  .footer{margin-top:18px;font-size:13px;color:#5a6b83}
  
  /* --- Estilos da Se√ß√£o de Login/Chat --- */
  #auth-container {
    padding: 15px;
    border: 1px solid #d7e0ee;
    border-radius: 8px;
    margin-bottom: 20px;
  }
  #chat-iframe-simulado {
    width: 100%;
    height: 350px;
    border: 1px solid #cbd7ea;
    border-radius: 4px;
    background-color: #f8faff;
    padding: 10px;
    overflow-y: auto; /* Scrollbar */
  }
  .chat-bubble-ai {
    background-color: #eef6ff;
    padding: 8px;
    border-radius: 6px;
    margin-bottom: 10px;
    color: #0b2545;
    font-size: 14px;
  }
  .chat-input-simulado {
      display: flex;
      margin-top: 10px;
      gap: 5px;
  }
</style>
</head>
<body>

<h1>Monitor de Portf√≥lio ‚Äî 10 Ativos (Horizonte 5 anos)</h1>
<p class="small">Preenchas um valor total (‚Ç¨) ou alteres % por ativo. A p√°gina tenta obter pre√ßos ao vivo; se houver bloqueio use a op√ß√£o "Inserir pre√ßos manuais". Sempre traz as tuas tabelas de refer√™ncia (Cen√°rio 2) √† direita.</p>

<div class="grid">
  <div>
    <h2>Tabela: Portf√≥lio 10 Ativos (atual)</h2>
    <table id="table-portfolio">
      <thead><tr><th>Ativo</th><th>% alvo</th><th>‚Ç¨ alvo</th><th>Pre√ßo (‚Ç¨)</th><th>Unidades (‚âà)</th><th>ISIN / Ticker</th><th>Segmento</th></tr></thead>
      <tbody></tbody>
      <tfoot></tfoot>
    </table>

    <label>Total dispon√≠vel (‚Ç¨)</label>
    <input id="input-total" type="number" value="500" min="1" step="0.01"/>

    <div style="margin-top:10px">
      <button id="btn-fetch">Buscar pre√ßos ao vivo (Yahoo + CoinGecko)</button>
      <button id="btn-manual" class="secondary">Inserir pre√ßos manuais</button>
      <button id="btn-alloc" class="secondary">Aplicar aloca√ß√£o e calcular</button>
      <button id="btn-csv" class="secondary">Exportar CSV</button>
    </div>

    <div class="note" id="status">Estado: pronto.</div>

    <h3>Op√ß√µes de Input / Ajustes</h3>
    <div class="small">
      <label>Modo de input:</label>
      <select id="mode">
        <option value="byWeight">Definir % (por ativo) ‚Äî padr√£o</option>
        <option value="byEuro">Definir ‚Ç¨ (por ativo)</option>
      </select>
      <p class="small">Podes editar % ou ‚Ç¨ em cada linha diretamente na tabela quando o modo estiver selecionado.</p>
    </div>

    <h3>Notas t√©cnicas</h3>
    <ul class="small">
      <li>BTC pre√ßo via CoinGecko (API p√∫blica). A√ß√µes/ETFs via Yahoo Finance quote endpoint.</li>
      <li>Se fetch falhar por CORS, use "Inserir pre√ßos manuais" e cola os pre√ßos.</li>
      <li>Unidades mostradas com 8 casas decimais; podes usar fra√ß√µes na Trade 212.</li>
    </ul>
  </div>

  <div>
    
    <div id="auth-container">
        <div id="login-section">
            <h3>üîí Acesso ao AI Insight (Chat GPT)</h3>
            <p class="small">√â necess√°rio login para acessar a ferramenta de insights de portf√≥lio.</p>
            <label for="username">Usu√°rio (Simulado: 'admin')</label>
            <input type="text" id="username" value="admin">
            <label for="password">Senha (Simulado: '123')</label>
            <input type="password" id="password" value="123">
            <button style="margin-top: 10px;" onclick="handleLogin()">Entrar</button>
            <div id="auth-message" class="note">Credenciais simuladas.</div>
        </div>

        <div id="chat-wrapper" style="display:none;">
            <h3>ü§ñ AI Insight (Chat GPT)</h3>
            
            <div id="chat-iframe-simulado">
                <div class="chat-bubble-ai">
                    **Bem-vindo, Admin!** Este √© um servi√ßo de insights de portf√≥lio.
                    <br><br>
                    **Nota:** Este √© um **iframe simulado**. Nenhuma chave API secreta est√° exposta, e n√£o h√° conex√£o real com o ChatGPT por quest√µes de seguran√ßa (keys secretas devem estar sempre em um servidor backend).
                </div>
                <div class="chat-bubble-ai">
                    **Exemplo de intera√ß√£o:** "Ajusta meu peso em Ouro para 20%" ou "Qual o risco da NVIDIA?"
                </div>
                
                <div id="chat-history"></div>
            </div>
            
            <div class="chat-input-simulado">
                <input type="text" id="chat-input" placeholder="Digite sua pergunta..." style="width: calc(100% - 80px);">
                <button onclick="simulateMessage()">Enviar</button>
            </div>
        </div>
    </div>
    
    <div>
        <h2>Tabela de Refer√™ncia ‚Äî Cen√°rio 2 (Conservador, ‚Ç¨500)</h2>
        <table id="table-cenario2">
          <thead><tr><th>Ativo</th><th>%</th><th>‚Ç¨</th><th>Pre√ßo (‚Ç¨)</th><th>Unidades (‚âà)</th><th>ISIN / Ticker</th></tr></thead>
          <tbody></tbody>
        </table>

        <div style="margin-top:12px">
          <h3>Resumo R√°pido</h3>
          <ul class="small">
            <li><strong>Rebalance</strong>: trimestral ou se desvio >5pp.</li>
            <li><strong>Execu√ß√£o</strong>: ordens limit se spreads ou not√≠cia relevante.</li>
            <li><strong>Fonte pre√ßos:</strong> Yahoo, CoinGecko ‚Äî sempre validar no Trade 212 antes de executar.</li>
          </ul>
        </div>
        <div class="footer">Gerido como: estilo <em>BlackRock</em> ‚Äî valida√ß√µes e fallback inclu√≠dos.</div>
    </div>
  </div>
</div>

<script>
/* ===========================
   Dados iniciais e mapping
   (SEM ALTERA√á√ïES)
   =========================== */
const assets = [
  {id:'VUAA', name:'VUAA', isin:'IE00BFMXXD54', tickerForYahoo:'VUAA.L', segment:'ETF S&P500', pct:18},
  {id:'MSFT', name:'Microsoft', isin:'US5949181045', tickerForYahoo:'MSFT', segment:'Tech / Cloud', pct:6},
  {id:'NVDA', name:'NVIDIA', isin:'US67066G1040', tickerForYahoo:'NVDA', segment:'AI / Chips', pct:4},
  {id:'LLY', name:'Eli Lilly', isin:'US5324571083', tickerForYahoo:'LLY', segment:'Farma / Biotech', pct:5},
  {id:'AVGO', name:'Broadcom', isin:'US11135F1012', tickerForYahoo:'AVGO', segment:'Infraestrutura AI', pct:5},
  {id:'GOOGL', name:'Alphabet', isin:'US02079K3059', tickerForYahoo:'GOOGL', segment:'Cloud / Ads / IA', pct:5},
  {id:'TSLA', name:'Tesla', isin:'US88160R1014', tickerForYahoo:'TSLA', segment:'Energia / Mobilidade', pct:4},
  {id:'INFY', name:'Infosys', isin:'US4567881085', tickerForYahoo:'INFY', segment:'Servi√ßos TI', pct:3},
  {id:'IGLD', name:'iShares Physical Gold ETC', isin:'IE00B4ND3602', tickerForYahoo:'IGLD.L', segment:'Ouro f√≠sico ETC', pct:30},
  {id:'BTC', name:'Bitcoin', isin:'', tickerForYahoo:'BTC-USD', segment:'Cripto', pct:15}
];

const defaultPrices = {
  'VUAA':112.15,'MSFT':456.70,'NVDA':165.24,'LLY':731.50,'AVGO':1495.00,'GOOGL':165.50,'TSLA':210.00,'INFY':17.40,'IGLD':70.17,'BTC':98899.12
};

/* ========== Rendering helpers (Manter as originais) ========== */
function renderPortfolioTable(prices) {
  const tbody = document.querySelector('#table-portfolio tbody');
  tbody.innerHTML = '';
  const total = Number(document.getElementById('input-total').value) || 0;
  assets.forEach(a=>{
    const row = document.createElement('tr');
    const price = (prices && prices[a.id])? Number(prices[a.id]) : defaultPrices[a.id];
    const pct = Number(a.pct);
    const euro = (total * pct/100);
    const units = price>0 ? (euro / price) : 0;
    row.innerHTML = `
      <td>${a.name}</td>
      <td contenteditable="true" data-field="pct" data-id="${a.id}">${pct.toFixed(2)}</td>
      <td contenteditable="true" data-field="euro" data-id="${a.id}">${euro.toFixed(2)}</td>
      <td><input type="text" data-price-id="${a.id}" value="${price.toString()}" style="width:120px"/></td>
      <td id="units-${a.id}">${units.toFixed(8)}</td>
      <td>${a.isin || a.tickerForYahoo} / ${a.tickerForYahoo}</td>
    `;
    tbody.appendChild(row);
  });
  attachEditableHandlers();
  updateFooterTotals();
}

function renderCenario2(prices) {
  const tbody = document.querySelector('#table-cenario2 tbody');
  tbody.innerHTML = '';
  const c2 = [
    {id:'VUAA', pct:40, euro:200},
    {id:'MSFT', pct:15, euro:75},
    {id:'NVDA', pct:5, euro:25},
    {id:'IGLD', pct:30, euro:150},
    {id:'BTC', pct:10, euro:50}
  ];
  c2.forEach(r=>{
    const price = (prices && prices[r.id])? Number(prices[r.id]) : defaultPrices[r.id];
    const units = price>0 ? (r.euro/price) : 0;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${r.id}</td><td>${r.pct}%</td><td>‚Ç¨${r.euro.toFixed(2)}</td><td>‚Ç¨${price.toFixed(4)}</td><td>${units.toFixed(8)}</td><td>${assets.find(x=>x.id===r.id)?.isin || assets.find(x=>x.id===r.id)?.tickerForYahoo}</td>`;
    tbody.appendChild(row);
  });
}

/* Fun√ß√µes auxiliares (Manter as originais) */
function attachEditableHandlers(){
  document.querySelectorAll('[contenteditable="true"]').forEach(cell=>{
    cell.onblur = ()=> {
      const id = cell.dataset.id;
      const field = cell.dataset.field;
      const total = Number(document.getElementById('input-total').value) || 0;
      if(field === 'pct'){
        let newPct = parseFloat(cell.innerText.replace('%','').trim());
        if(isNaN(newPct) || newPct<0) { cell.innerText = assets.find(a=>a.id===id).pct.toFixed(2); return; }
        assets.find(a=>a.id===id).pct = newPct;
        const euroCell = document.querySelector(`[data-field="euro"][data-id="${id}"]`);
        const newEuro = (total * newPct/100);
        euroCell.innerText = newEuro.toFixed(2);
      } else {
        let newEuro = parseFloat(cell.innerText.replace('‚Ç¨','').trim());
        if(isNaN(newEuro) || newEuro<0){ cell.innerText = (total * assets.find(a=>a.id===id).pct/100).toFixed(2); return; }
        const newPct = total>0 ? (newEuro/total*100) : 0;
        assets.find(a=>a.id===id).pct = newPct;
        const pctCell = document.querySelector(`[data-field="pct"][data-id="${id}"]`);
        pctCell.innerText = newPct.toFixed(2);
      }
      recalcUnitsFromPrices();
      updateFooterTotals();
    };
  });
  document.querySelectorAll('input[data-price-id]').forEach(inp=>{
    inp.onchange = ()=> {
      const aid = inp.dataset.priceId;
      const val = parseFloat(inp.value);
      if(isNaN(val) || val<=0){ alert('Pre√ßo inv√°lido. Insere um n√∫mero > 0.'); inp.value = defaultPrices[aid]; return; }
      const total = Number(document.getElementById('input-total').value) || 0;
      const pct = assets.find(a=>a.id===aid).pct;
      const euro = (total * pct/100);
      const units = euro / val;
      document.getElementById('units-'+aid).innerText = units.toFixed(8);
      updateFooterTotals();
    };
  });
}

function recalcUnitsFromPrices(){
  const total = Number(document.getElementById('input-total').value) || 0;
  assets.forEach(a=>{
    const priceInput = document.querySelector(`input[data-price-id="${a.id}"]`);
    const price = priceInput ? parseFloat(priceInput.value) : defaultPrices[a.id];
    const units = price>0 ? (total * a.pct/100) / price : 0;
    document.getElementById('units-'+a.id).innerText = units.toFixed(8);
    const euroCell = document.querySelector(`[data-field="euro"][data-id="${a.id}"]`);
    if(euroCell) euroCell.innerText = (total * a.pct/100).toFixed(2);
  });
  updateFooterTotals();
}

function updateFooterTotals(){
  const sumPct = assets.reduce((s,a)=>s + Number(a.pct),0);
  const sElem = document.getElementById('status');
  if(Math.abs(sumPct - 100) > 0.5){
    sElem.innerHTML = `<span class="error">Soma dos % = ${sumPct.toFixed(2)}% (dever√° ser ~100%). Ajusta manualmente ou usa "Aplicar aloca√ß√£o".</span>`;
  } else {
    sElem.innerHTML = `<span class="success">Soma dos % = ${sumPct.toFixed(2)}% ‚Äî OK.</span>`;
  }
}

function fetchPricesLive(){ /* ... (c√≥digo fetch original) ... */ }
function enableManualPrices(){ /* ... (c√≥digo manual original) ... */ }
function applyAllocation(){ /* ... (c√≥digo alloc original) ... */ }
function exportCSV(){ /* ... (c√≥digo CSV original) ... */ }

/* =======================================================
   NOVAS FUN√á√ïES PARA SIMULA√á√ÉO DE LOGIN E CHAT IFRAME
   ======================================================= */

function handleLogin() {
  const user = document.getElementById('username').value;
  const pass = document.getElementById('password').value;
  const message = document.getElementById('auth-message');
  
  // L√≥gica de login simples SIMULADA
  if (user === 'admin' && pass === '123') {
    document.getElementById('login-section').style.display = 'none';
    document.getElementById('chat-wrapper').style.display = 'block';
    // Mudar mensagem de status
    message.innerHTML = '<span class="success">Login bem-sucedido. Chat de Insights ativo.</span>';
  } else {
    message.innerHTML = '<span class="error">Login falhou. Tente novamente com admin/123.</span>';
  }
}

function simulateMessage() {
  const input = document.getElementById('chat-input');
  const history = document.getElementById('chat-history');
  const userMessage = input.value.trim();

  if (userMessage === '') return;
  
  // 1. Mostrar a mensagem do usu√°rio
  history.innerHTML += `<div style="text-align: right; margin-bottom: 5px;"><span style="background-color: #d7e0ee; padding: 5px 10px; border-radius: 6px;">**Voc√™:** ${userMessage}</span></div>`;
  
  // 2. Simular a resposta do Bot
  let botResponse = '';
  if (userMessage.toLowerCase().includes('ouro') || userMessage.toLowerCase().includes('igld')) {
    botResponse = "Entendido. Diminuir Ouro para 20% libera 10% da aloca√ß√£o. Recomenda-se realocar esse percentual para VUAA (a√ß√µes) para maior potencial de crescimento no longo prazo.";
  } else if (userMessage.toLowerCase().includes('nvidia') || userMessage.toLowerCase().includes('nvda')) {
    botResponse = "A NVIDIA √© fundamental na infraestrutura de IA. Manter 4% de peso est√° dentro do risco. Se desejar mais exposi√ß√£o ao tema AI, considere elevar o percentual, compensando a redu√ß√£o em outro ativo de alto risco como o BTC.";
  } else {
    botResponse = "Obrigado pela sua quest√£o. Como este √© um chat simulado, voc√™ precisa de um *backend* seguro para integrar o ChatGPT real e obter insights em tempo real sobre seu portf√≥lio de 10 ativos.";
  }

  // Simular o tempo de resposta
  setTimeout(() => {
    history.innerHTML += `<div class="chat-bubble-ai">**AI Insight:** ${botResponse}</div>`;
    // Scroll para o fim
    document.getElementById('chat-iframe-simulado').scrollTop = document.getElementById('chat-iframe-simulado').scrollHeight;
  }, 800);

  // 3. Limpar o input
  input.value = '';
}

/* ========== Init (Inicializa√ß√£o da p√°gina) ======= */
document.getElementById('btn-fetch').addEventListener('click', ()=>fetchPricesLive());
document.getElementById('btn-manual').addEventListener('click', ()=>enableManualPrices());
document.getElementById('btn-alloc').addEventListener('click', ()=>applyAllocation());
document.getElementById('btn-csv').addEventListener('click', ()=>exportCSV());
document.getElementById('input-total').addEventListener('change', ()=>renderPortfolioTable());
document.getElementById('mode').addEventListener('change', (e)=>{ document.getElementById('status').innerText = 'Modo alterado: edita a tabela conforme necess√°rio.'; });

/* first render using defaults */
renderPortfolioTable(defaultPrices);
renderCenario2(defaultPrices);
</script>
</body>
</html>
