<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Monitoramento Inteligente - PortfÃ³lio 10 Ativos</title>
  <style>
    body { font-family: Arial, sans-serif; background: #0a0a0a; color: #e0e0e0; margin: 20px; }
    h1 { color: #00ffcc; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #444; padding: 10px; text-align: center; }
    th { background-color: #1e1e1e; }
    input[type="text"] { width: 80px; text-align: right; background: #1a1a1a; color: #fff; border: 1px solid #444; border-radius: 3px; }
    button { background: #00ffcc; color: #000; border: none; padding: 10px 20px; cursor: pointer; border-radius: 5px; margin-top: 20px; }
    button:hover { background: #00e0b3; }
    .footer { margin-top: 20px; font-size: 12px; color: #888; }
  </style>
</head>
<body>
  <h1>ðŸ“ˆ Monitoramento Inteligente - PortfÃ³lio Longo Prazo</h1>
  <p>Busca automÃ¡tica de preÃ§os em EUR (TwelveData â†’ CoinGecko â†’ Google Finance â†’ Manual)</p>

  <table id="portfolioTable">
    <thead>
      <tr>
        <th>Ativo</th>
        <th>%</th>
        <th>Valor (â‚¬)</th>
        <th>PreÃ§o Atual (â‚¬)</th>
        <th>Unidades</th>
        <th>Segmento</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button onclick="updatePortfolio()">ðŸ”„ Atualizar PreÃ§os</button>

  <div class="footer">Fonte: TwelveData, CoinGecko, Google Finance, JustETF</div>

  <script>
    // âœ… TUA API KEY TwelveData
    const apiKey = "0debbec4427d429c993d43982dbf9848";

    const portfolio = [
      { symbol: "VUAA.L", percent: 18, value: 90, segment: "ETF S&P500 (IE00BFMXXD54)" },
      { symbol: "MSFT", percent: 6, value: 30, segment: "Tech / Cloud" },
      { symbol: "NVDA", percent: 4, value: 20, segment: "AI / Chips" },
      { symbol: "LLY", percent: 5, value: 25, segment: "Farma / Biotech" },
      { symbol: "AVGO", percent: 5, value: 25, segment: "Infraestrutura AI" },
      { symbol: "GOOGL", percent: 5, value: 25, segment: "Cloud / Ads / IA" },
      { symbol: "TSLA", percent: 4, value: 20, segment: "Energia / Mobilidade" },
      { symbol: "INFY", percent: 3, value: 15, segment: "ServiÃ§os TI" },
      { symbol: "IGLD.L", percent: 30, value: 150, segment: "Ouro fÃ­sico ETC" },
      { symbol: "BTC-EUR", percent: 15, value: 75, segment: "Cripto" }
    ];

    const tableBody = document.querySelector("#portfolioTable tbody");

    function loadTable() {
      tableBody.innerHTML = "";
      portfolio.forEach(p => {
        const row = `
          <tr>
            <td>${p.symbol}</td>
            <td>${p.percent}%</td>
            <td contenteditable="true">${p.value.toFixed(2)}</td>
            <td><input type="text" placeholder="â€”" class="priceInput"></td>
            <td class="units">â€”</td>
            <td>${p.segment}</td>
          </tr>`;
        tableBody.insertAdjacentHTML("beforeend", row);
      });
    }

    async function fetchPrice(symbol) {
      const turl = `https://api.twelvedata.com/price?symbol=${symbol}&apikey=${apiKey}&currency=EUR`;
      try {
        const r = await fetch(turl);
        const j = await r.json();
        if (j && j.price && !isNaN(j.price)) return parseFloat(j.price);
      } catch (e) {}

      // fallback BTC
      if (symbol.includes("BTC")) {
        const res = await fetch("https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur");
        const data = await res.json();
        return data.bitcoin.eur;
      }

      // fallback Google Finance (scraping leve)
      try {
        const gsym = symbol.replace(".L", ":LON");
        const gres = await fetch(`https://www.google.com/finance/quote/${gsym}`);
        const text = await gres.text();
        const match = text.match(/"regularMarketPrice":\{"raw":([\d.]+)/);
        if (match && match[1]) return parseFloat(match[1]);
      } catch (e) {}

      return NaN;
    }

    async function updatePortfolio() {
      const rows = document.querySelectorAll("#portfolioTable tbody tr");

      for (let i = 0; i < portfolio.length; i++) {
        const p = portfolio[i];
        const row = rows[i];
        const value = parseFloat(row.children[2].innerText);
        const priceField = row.querySelector(".priceInput");

        let price = await fetchPrice(p.symbol);

        if (!isNaN(price)) {
          priceField.value = price.toFixed(2);
          priceField.disabled = true;
          const units = (value / price).toFixed(3);
          row.children[4].innerText = units;
        } else {
          priceField.disabled = false;
          priceField.placeholder = "Digite â‚¬";
          row.children[4].innerText = "â€”";
        }

        priceField.addEventListener("input", () => {
          const manualPrice = parseFloat(priceField.value);
          if (!isNaN(manualPrice)) {
            const units = (value / manualPrice).toFixed(3);
            row.children[4].innerText = units;
          } else {
            row.children[4].innerText = "â€”";
          }
        });
      }
    }

    loadTable();
  </script>
</body>
</html>