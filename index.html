<!doctype html>
<html lang="pt-PT">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Monitor de Portfólio — 10 Ativos / Cenário 2</title>
<style>
  body {font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin:20px; color:#0b2545;}
  h1,h2,h3{color:#072244}
  table{border-collapse:collapse;width:100%;margin-bottom:12px}
  th,td{border:1px solid #d7e0ee;padding:8px;text-align:left;font-size:14px}
  th{background:#eef6ff}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:20px}
  label{display:block;margin:8px 0 4px;font-weight:600}
  input[type="number"], input[type="text"], select {width:100%;padding:8px;border:1px solid #cbd7ea;border-radius:4px}
  button{background:#0b5ed7;color:#fff;padding:8px 12px;border:0;border-radius:6px;cursor:pointer;margin-right:8px}
  button.secondary{background:#6c7a89}
  .note{font-size:13px;color:#4b5563;margin-top:8px}
  .error{color:#a80000;font-weight:700}
  .success{color:#0a7a3b;font-weight:700}
  .small{font-size:13px;color:#4b5563}
  .flex{display:flex;gap:8px;align-items:center}
  .footer{margin-top:18px;font-size:13px;color:#5a6b83}
</style>
</head>
<body>

<h1>Monitor de Portfólio — 10 Ativos (Horizonte 5 anos)</h1>
<p class="small">Preenchas um valor total (€) ou alteres % por ativo. A página tenta obter preços ao vivo; se houver bloqueio use a opção "Inserir preços manuais". Sempre traz as tuas tabelas de referência (Cenário 2) à direita.</p>

<div class="grid">
  <div>
    <h2>Tabela: Portfólio 10 Ativos (atual)</h2>
    <table id="table-portfolio">
      <thead><tr><th>Ativo</th><th>% alvo</th><th>€ alvo</th><th>Preço (€)</th><th>Unidades (≈)</th><th>ISIN / Ticker</th><th>Segmento</th></tr></thead>
      <tbody></tbody>
      <tfoot></tfoot>
    </table>

    <label>Total disponível (€)</label>
    <input id="input-total" type="number" value="500" min="1" step="0.01"/>

    <div style="margin-top:10px">
      <button id="btn-fetch">Buscar preços ao vivo (Yahoo + CoinGecko)</button>
      <button id="btn-manual" class="secondary">Inserir preços manuais</button>
      <button id="btn-alloc" class="secondary">Aplicar alocação e calcular</button>
      <button id="btn-csv" class="secondary">Exportar CSV</button>
    </div>

    <div class="note" id="status">Estado: pronto.</div>

    <h3>Opções de Input / Ajustes</h3>
    <div class="small">
      <label>Modo de input:</label>
      <select id="mode">
        <option value="byWeight">Definir % (por ativo) — padrão</option>
        <option value="byEuro">Definir € (por ativo)</option>
      </select>
      <p class="small">Podes editar % ou € em cada linha diretamente na tabela quando o modo estiver selecionado.</p>
    </div>

    <h3>Notas técnicas</h3>
    <ul class="small">
      <li>BTC preço via CoinGecko (API pública). Ações/ETFs via Yahoo Finance quote endpoint.</li>
      <li>Se fetch falhar por CORS, use "Inserir preços manuais" e cola os preços.</li>
      <li>Unidades mostradas com 8 casas decimais; podes usar frações na Trade 212.</li>
    </ul>
  </div>

  <div>
    <h2>Tabela de Referência — Cenário 2 (Conservador, €500)</h2>
    <table id="table-cenario2">
      <thead><tr><th>Ativo</th><th>%</th><th>€</th><th>Preço (€)</th><th>Unidades (≈)</th><th>ISIN / Ticker</th></tr></thead>
      <tbody></tbody>
    </table>

    <div style="margin-top:12px">
      <h3>Resumo Rápido</h3>
      <ul class="small">
        <li><strong>Rebalance</strong>: trimestral ou se desvio >5pp.</li>
        <li><strong>Execução</strong>: ordens limit se spreads ou notícia relevante.</li>
        <li><strong>Fonte preços:</strong> Yahoo, CoinGecko — sempre validar no Trade 212 antes de executar.</li>
      </ul>
    </div>
    <div class="footer">Gerido como: estilo <em>BlackRock</em> — validações e fallback incluídos.</div>
  </div>
</div>

<script>
/* ===========================
   Dados iniciais e mapping
   =========================== */
const assets = [
  {id:'VUAA', name:'VUAA', isin:'IE00BFMXXD54', tickerForYahoo:'VUAA.L', segment:'ETF S&P500', pct:18},
  {id:'MSFT', name:'Microsoft', isin:'US5949181045', tickerForYahoo:'MSFT', segment:'Tech / Cloud', pct:6},
  {id:'NVDA', name:'NVIDIA', isin:'US67066G1040', tickerForYahoo:'NVDA', segment:'AI / Chips', pct:4},
  {id:'LLY', name:'Eli Lilly', isin:'US5324571083', tickerForYahoo:'LLY', segment:'Farma / Biotech', pct:5},
  {id:'AVGO', name:'Broadcom', isin:'US11135F1012', tickerForYahoo:'AVGO', segment:'Infraestrutura AI', pct:5},
  {id:'GOOGL', name:'Alphabet', isin:'US02079K3059', tickerForYahoo:'GOOGL', segment:'Cloud / Ads / IA', pct:5},
  {id:'TSLA', name:'Tesla', isin:'US88160R1014', tickerForYahoo:'TSLA', segment:'Energia / Mobilidade', pct:4},
  {id:'INFY', name:'Infosys', isin:'US4567881085', tickerForYahoo:'INFY', segment:'Serviços TI', pct:3},
  {id:'IGLD', name:'iShares Physical Gold ETC', isin:'IE00B4ND3602', tickerForYahoo:'IGLD.L', segment:'Ouro físico ETC', pct:30},
  {id:'BTC', name:'Bitcoin', isin:'', tickerForYahoo:'BTC-USD', segment:'Cripto', pct:15}
];

const defaultPrices = {
  'VUAA':112.15,'MSFT':456.70,'NVDA':165.24,'LLY':731.50,'AVGO':1495.00,'GOOGL':165.50,'TSLA':210.00,'INFY':17.40,'IGLD':70.17,'BTC':98899.12
};

/* ========== Rendering helpers ========== */
function renderPortfolioTable(prices) {
  const tbody = document.querySelector('#table-portfolio tbody');
  tbody.innerHTML = '';
  const total = Number(document.getElementById('input-total').value) || 0;
  assets.forEach(a=>{
    const row = document.createElement('tr');
    const price = (prices && prices[a.id])? Number(prices[a.id]) : defaultPrices[a.id];
    const pct = Number(a.pct);
    const euro = (total * pct/100);
    const units = price>0 ? (euro / price) : 0;
    row.innerHTML = `
      <td>${a.name}</td>
      <td contenteditable="true" data-field="pct" data-id="${a.id}">${pct.toFixed(2)}</td>
      <td contenteditable="true" data-field="euro" data-id="${a.id}">${euro.toFixed(2)}</td>
      <td><input type="text" data-price-id="${a.id}" value="${price.toString()}" style="width:120px"/></td>
      <td id="units-${a.id}">${units.toFixed(8)}</td>
      <td>${a.isin || a.tickerForYahoo} / ${a.tickerForYahoo}</td>
    `;
    tbody.appendChild(row);
  });
  attachEditableHandlers();
  updateFooterTotals();
}

function renderCenario2(prices) {
  const tbody = document.querySelector('#table-cenario2 tbody');
  tbody.innerHTML = '';
  const c2 = [
    {id:'VUAA', pct:40, euro:200},
    {id:'MSFT', pct:15, euro:75},
    {id:'NVDA', pct:5, euro:25},
    {id:'IGLD', pct:30, euro:150},
    {id:'BTC', pct:10, euro:50}
  ];
  c2.forEach(r=>{
    const price = (prices && prices[r.id])? Number(prices[r.id]) : defaultPrices[r.id];
    const units = price>0 ? (r.euro/price) : 0;
    const row = document.createElement('tr');
    row.innerHTML = `<td>${r.id}</td><td>${r.pct}%</td><td>€${r.euro.toFixed(2)}</td><td>€${price.toFixed(4)}</td><td>${units.toFixed(8)}</td><td>${assets.find(x=>x.id===r.id)?.isin || assets.find(x=>x.id===r.id)?.tickerForYahoo}</td>`;
    tbody.appendChild(row);
  });
}

/* ========== Event handlers ========== */
function attachEditableHandlers(){
  // contenteditable cells: when user edits pct or euro, sync the other column
  document.querySelectorAll('[contenteditable="true"]').forEach(cell=>{
    cell.onblur = ()=> {
      const id = cell.dataset.id;
      const field = cell.dataset.field;
      const total = Number(document.getElementById('input-total').value) || 0;
      if(field === 'pct'){
        let newPct = parseFloat(cell.innerText.replace('%','').trim());
        if(isNaN(newPct) || newPct<0) { cell.innerText = assets.find(a=>a.id===id).pct.toFixed(2); return; }
        assets.find(a=>a.id===id).pct = newPct;
        // update € cell
        const euroCell = document.querySelector(`[data-field="euro"][data-id="${id}"]`);
        const newEuro = (total * newPct/100);
        euroCell.innerText = newEuro.toFixed(2);
      } else {
        let newEuro = parseFloat(cell.innerText.replace('€','').trim());
        if(isNaN(newEuro) || newEuro<0){ cell.innerText = (total * assets.find(a=>a.id===id).pct/100).toFixed(2); return; }
        // recalc pct for this asset only (keeps others same)
        const newPct = total>0 ? (newEuro/total*100) : 0;
        assets.find(a=>a.id===id).pct = newPct;
        const pctCell = document.querySelector(`[data-field="pct"][data-id="${id}"]`);
        pctCell.innerText = newPct.toFixed(2);
      }
      recalcUnitsFromPrices();
      updateFooterTotals();
    };
  });
  // price inputs
  document.querySelectorAll('input[data-price-id]').forEach(inp=>{
    inp.onchange = ()=> {
      const aid = inp.dataset.priceId;
      const val = parseFloat(inp.value);
      if(isNaN(val) || val<=0){ alert('Preço inválido. Insere um número > 0.'); inp.value = defaultPrices[aid]; return; }
      // update units cell
      const total = Number(document.getElementById('input-total').value) || 0;
      const pct = assets.find(a=>a.id===aid).pct;
      const euro = (total * pct/100);
      const units = euro / val;
      document.getElementById('units-'+aid).innerText = units.toFixed(8);
      updateFooterTotals();
    };
  });
}

function recalcUnitsFromPrices(){
  const total = Number(document.getElementById('input-total').value) || 0;
  assets.forEach(a=>{
    const priceInput = document.querySelector(`input[data-price-id="${a.id}"]`);
    const price = priceInput ? parseFloat(priceInput.value) : defaultPrices[a.id];
    const units = price>0 ? (total * a.pct/100) / price : 0;
    document.getElementById('units-'+a.id).innerText = units.toFixed(8);
    // update € displayed cell too
    const euroCell = document.querySelector(`[data-field="euro"][data-id="${a.id}"]`);
    if(euroCell) euroCell.innerText = (total * a.pct/100).toFixed(2);
  });
  updateFooterTotals();
}

function updateFooterTotals(){
  // ensure sum pct near 100
  const sumPct = assets.reduce((s,a)=>s + Number(a.pct),0);
  const sElem = document.getElementById('status');
  if(Math.abs(sumPct - 100) > 0.5){
    sElem.innerHTML = `<span class="error">Soma dos % = ${sumPct.toFixed(2)}% (deverá ser ~100%). Ajusta manualmente ou usa "Aplicar alocação".</span>`;
  } else {
    sElem.innerHTML = `<span class="success">Soma dos % = ${sumPct.toFixed(2)}% — OK.</span>`;
  }
}

/* ========== Fetch preços ao vivo ========== */
async function fetchPricesLive(){
  document.getElementById('status').innerText = 'Estado: a buscar preços ao vivo...';
  // prepare Yahoo symbols list (comma separated)
  const yahooSymbols = assets.filter(a=>a.id!=='BTC').map(a=>encodeURIComponent(a.tickerForYahoo)).join(',');
  const yahooUrl = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${yahooSymbols}`;
  const coingeckoUrl = 'https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=eur';

  try{
    // fetch Yahoo
    const yResp = await fetch(yahooUrl);
    if(!yResp.ok) throw new Error('Yahoo fetch falhou: ' + yResp.status);
    const yJson = await yResp.json();
    const quotes = {};
    if(yJson && yJson.quoteResponse && Array.isArray(yJson.quoteResponse.result)){
      yJson.quoteResponse.result.forEach(q=>{
        // symbol map: Yahoo returns symbol like MSFT, VUAA.L etc.
        // use 'symbol' to match assets.tickerForYahoo
        const asset = assets.find(a => a.tickerForYahoo === q.symbol);
        if(asset){
          quotes[asset.id] = q.regularMarketPrice || q.ask || q.bid || null;
        }
      });
    }
    // fetch BTC
    const cResp = await fetch(coingeckoUrl);
    if(!cResp.ok) throw new Error('CoinGecko fetch falhou: ' + cResp.status);
    const cJson = await cResp.json();
    if(cJson && cJson.bitcoin && cJson.bitcoin.eur){
      quotes['BTC'] = Number(cJson.bitcoin.eur);
    }
    // verify results: any null -> fallback
    let anyNull = false;
    assets.forEach(a=>{ if(!quotes[a.id] || isNaN(quotes[a.id])) anyNull = true; });
    if(anyNull){
      // partial or full failure: show warning but still apply values we have
      const msg = 'Busca parcial de preços: alguns instrumentos não retornaram preço (CORS ou ticker mismatch). Tens a opção "Inserir preços manuais".';
      document.getElementById('status').innerHTML = `<span class="error">${msg}</span>`;
    } else {
      document.getElementById('status').innerHTML = `<span class="success">Preços ao vivo obtidos e aplicados com sucesso.</span>`;
    }
    // apply quotes to inputs
    assets.forEach(a=>{
      const inp = document.querySelector(`input[data-price-id="${a.id}"]`);
      if(inp && quotes[a.id]) inp.value = Number(quotes[a.id]).toString();
    });
    recalcUnitsFromPrices();
    renderCenario2(quotes);
  } catch(err){
    document.getElementById('status').innerHTML = `<span class="error">Erro ao buscar preços ao vivo: ${err.message}. Usa "Inserir preços manuais".</span>`;
    // still render Cenario2 with defaults
    renderCenario2(null);
  }
}

/* ========== Manual price mode: show a prompt to paste prices JSON or CSV ======= */
function enableManualPrices(){
  const txt = prompt('Insere preços manuais no formato CSV: SYMBOL,PRICE (ex: MSFT,456.7). Um par por linha. Ou clica Cancel para manter preços atuais.');
  if(!txt) return;
  const lines = txt.split('\\n').map(s=>s.trim()).filter(Boolean);
  lines.forEach(line=>{
    const parts = line.split(',').map(p=>p.trim());
    if(parts.length>=2){
      const symbol = parts[0].toUpperCase();
      const price = parseFloat(parts[1]);
      // map symbol to asset id (match tickerForYahoo or id)
      const asset = assets.find(a=>a.tickerForYahoo.toUpperCase()===symbol || a.id.toUpperCase()===symbol);
      if(asset && !isNaN(price) && price>0){
        const inp = document.querySelector(`input[data-price-id="${asset.id}"]`);
        if(inp) inp.value = price;
      }
    }
  });
  recalcUnitsFromPrices();
  document.getElementById('status').innerHTML = '<span class="success">Preços manuais aplicados.</span>';
}

/* ========== Allocation calculate button ========== */
function applyAllocation(){
  // read mode and recalc units
  recalcUnitsFromPrices();
  // final check: sum of % must be ~100
  const sumPct = assets.reduce((s,a)=>s + Number(a.pct),0);
  if(Math.abs(sumPct - 100) > 0.5){
    if(!confirm(`Soma dos % = ${sumPct.toFixed(2)}% (não está ~100%). Desejas prosseguir?`)) return;
  }
  document.getElementById('status').innerHTML = '<span class="success">Alocação aplicada. Vê a tabela e exporta CSV se necessário.</span>';
}

/* ========== CSV export ======= */
function exportCSV(){
  const total = Number(document.getElementById('input-total').value) || 0;
  let csv = 'Asset,ISIN/Ticker,Segment,Percent (%),Euro (€),Price (€),Units\\n';
  assets.forEach(a=>{
    const pct = Number(a.pct);
    const euro = (total * pct/100).toFixed(2);
    const price = document.querySelector(`input[data-price-id="${a.id}"]`).value;
    const units = document.getElementById('units-'+a.id).innerText;
    csv += `${a.id},"${a.isin || a.tickerForYahoo}","${a.segment}",${pct.toFixed(2)},${euro},${price},${units}\\n`;
  });
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'portfolio_allocation.csv'; a.style.display='none';
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
}

/* ========== Init ======= */
document.getElementById('btn-fetch').addEventListener('click', ()=>fetchPricesLive());
document.getElementById('btn-manual').addEventListener('click', ()=>enableManualPrices());
document.getElementById('btn-alloc').addEventListener('click', ()=>applyAllocation());
document.getElementById('btn-csv').addEventListener('click', ()=>exportCSV());
document.getElementById('input-total').addEventListener('change', ()=>renderPortfolioTable());
document.getElementById('mode').addEventListener('change', (e)=>{ document.getElementById('status').innerText = 'Modo alterado: edita a tabela conforme necessário.'; });

/* first render using defaults */
renderPortfolioTable(defaultPrices);
renderCenario2(defaultPrices);
</script>
</body>
</html>
